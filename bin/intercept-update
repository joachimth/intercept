#!/bin/bash
# intercept-update - Update INTERCEPT to latest version

set -e

INSTALL_DIR="/opt/intercept"
BACKUP_DIR="$INSTALL_DIR/data/backups"

echo "================================================"
echo "  INTERCEPT Update"
echo "================================================"
echo ""

# Check if running as root
if [[ $EUID -ne 0 ]]; then
   echo "âŒ This script must be run as root (use sudo)"
   exit 1
fi

# Check if INTERCEPT is installed
if [ ! -d "$INSTALL_DIR" ]; then
    echo "âŒ INTERCEPT not found at $INSTALL_DIR"
    echo "   Run 'intercept-init' to install"
    exit 1
fi

cd "$INSTALL_DIR"

echo "ğŸ“¦ Current version:"
git log -1 --format="%h - %s (%cr)" || echo "Unknown"

echo ""
echo "ğŸ”„ Checking for updates..."

# Fetch latest changes
git fetch origin

# Check if updates are available
LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse @{u})

if [ $LOCAL = $REMOTE ]; then
    echo "   âœ… Already up to date!"
else
    echo "   ğŸ“¥ Updates available"

    # Create backup
    echo ""
    echo "ğŸ’¾ Creating backup..."
    mkdir -p "$BACKUP_DIR"
    BACKUP_FILE="$BACKUP_DIR/intercept_$(date +%Y%m%d_%H%M%S).tar.gz"
    tar -czf "$BACKUP_FILE" -C "$INSTALL_DIR" data .env 2>/dev/null || true
    echo "   âœ… Backup saved: $BACKUP_FILE"

    # Pull updates
    echo ""
    echo "ğŸ“¥ Pulling latest code..."
    git pull --ff-only origin main

    echo "   âœ… Code updated"
fi

echo ""
echo "ğŸ‹ Updating Docker images..."
docker-compose pull

echo ""
echo "ğŸ”„ Restarting containers..."
docker-compose up -d

echo ""
echo "================================================"
echo "  âœ… Update Complete!"
echo "================================================"
echo ""
echo "ğŸ“¦ New version:"
git log -1 --format="%h - %s (%cr)"

echo ""
echo "ğŸ“‹ View logs:"
echo "   intercept-logs"
echo ""
echo "ğŸŒ Access web interface:"
echo "   http://$(hostname -I | awk '{print $1}'):5050"
echo ""
