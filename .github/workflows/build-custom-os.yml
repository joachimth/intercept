name: Build Custom Raspberry Pi OS Image

on:
  workflow_dispatch:
    inputs:
      rpi_os_version:
        description: 'Raspberry Pi OS version date (e.g., 2024-11-19)'
        required: false
        default: '2024-11-19'
      image_type:
        description: 'Image type (lite/full/desktop)'
        required: false
        default: 'lite'
        type: choice
        options:
          - lite
          - full
          - desktop
  release:
    types: [published]
  push:
    tags:
      - 'v*'

env:
  IMAGE_NAME: intercept-rpi-os

jobs:
  build-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment variables
        id: vars
        run: |
          # Get version from tag or use 'latest'
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="latest"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

          # Set RPI OS version
          RPI_OS_VERSION="${{ github.event.inputs.rpi_os_version || '2024-11-19' }}"
          echo "RPI_OS_VERSION=$RPI_OS_VERSION" >> $GITHUB_OUTPUT

          # Set image type
          IMAGE_TYPE="${{ github.event.inputs.image_type || 'lite' }}"
          echo "IMAGE_TYPE=$IMAGE_TYPE" >> $GITHUB_OUTPUT

          # Construct image filename
          IMAGE_FILENAME="${IMAGE_NAME}-${VERSION}.img"
          echo "IMAGE_FILENAME=$IMAGE_FILENAME" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            curl \
            unzip \
            xz-utils \
            kpartx \
            qemu-user-static \
            binfmt-support \
            parted \
            fdisk \
            dosfstools \
            e2fsprogs \
            systemd-container \
            rsync

      - name: Download Raspberry Pi OS image
        run: |
          RPI_OS_VERSION="${{ steps.vars.outputs.RPI_OS_VERSION }}"
          IMAGE_TYPE="${{ steps.vars.outputs.IMAGE_TYPE }}"

          # Try to download latest lite image first (simpler and more reliable)
          echo "Downloading Raspberry Pi OS Lite (latest)..."
          wget -O raspios.img.xz "https://downloads.raspberrypi.org/raspios_lite_armhf_latest" || {
            echo "Failed to download, trying alternative source..."
            # Fallback to specific version if needed
            wget -O raspios.img.xz "https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-${RPI_OS_VERSION}/${RPI_OS_VERSION}-raspios-bookworm-armhf-lite.img.xz"
          }

          echo "Extracting image..."
          xz -d raspios.img.xz
          mv raspios.img base-image.img

      - name: Expand image size
        run: |
          # Add 6GB to the image for intercept and dependencies
          dd if=/dev/zero bs=1M count=6144 >> base-image.img

          # Expand the root partition
          echo ", +" | sudo sfdisk -N 2 base-image.img

          # Set up loop device
          LOOP_DEVICE=$(sudo losetup -fP --show base-image.img)
          echo "LOOP_DEVICE=$LOOP_DEVICE" >> $GITHUB_ENV

          # Resize the filesystem
          sudo e2fsck -f -y ${LOOP_DEVICE}p2 || true
          sudo resize2fs ${LOOP_DEVICE}p2

          # Detach loop device for now
          sudo losetup -d $LOOP_DEVICE

      - name: Mount image and customize
        run: |
          # Set up loop device
          LOOP_DEVICE=$(sudo losetup -fP --show base-image.img)
          echo "Using loop device: $LOOP_DEVICE"

          # Create mount points
          sudo mkdir -p /mnt/rpi-boot /mnt/rpi-root

          # Mount partitions
          sudo mount ${LOOP_DEVICE}p1 /mnt/rpi-boot
          sudo mount ${LOOP_DEVICE}p2 /mnt/rpi-root

          # Copy intercept files (exclude large/unnecessary files)
          echo "Copying intercept files to image..."
          sudo mkdir -p /mnt/rpi-root/opt/intercept
          sudo rsync -a --exclude='.git' \
            --exclude='base-image.img' \
            --exclude='*.img' \
            --exclude='*.img.xz' \
            --exclude='*.iso' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.pytest_cache' \
            --exclude='venv' \
            ./ /mnt/rpi-root/opt/intercept/

          # Copy customization script
          sudo cp .github/scripts/customize-image.sh /mnt/rpi-root/tmp/customize-image.sh
          sudo chmod +x /mnt/rpi-root/tmp/customize-image.sh

          # Copy systemd service file
          sudo cp .github/scripts/intercept.service /mnt/rpi-root/etc/systemd/system/intercept.service

          # Enable SSH (create empty ssh file in boot partition)
          sudo touch /mnt/rpi-boot/ssh

          # Store loop device for later
          echo "LOOP_DEVICE=$LOOP_DEVICE" >> $GITHUB_ENV

      - name: Run customization script in chroot
        run: |
          # Copy qemu-arm-static for ARM emulation
          sudo cp /usr/bin/qemu-arm-static /mnt/rpi-root/usr/bin/

          # Mount necessary pseudo-filesystems for chroot
          echo "Mounting pseudo-filesystems for chroot..."
          sudo mount -t proc proc /mnt/rpi-root/proc
          sudo mount -t sysfs sys /mnt/rpi-root/sys
          sudo mount -o bind /dev /mnt/rpi-root/dev
          sudo mount -o bind /dev/pts /mnt/rpi-root/dev/pts

          # Run customization script in chroot
          echo "Running customization script..."
          sudo chroot /mnt/rpi-root /bin/bash /tmp/customize-image.sh

          # Unmount pseudo-filesystems
          echo "Unmounting pseudo-filesystems..."
          sudo umount /mnt/rpi-root/dev/pts || true
          sudo umount /mnt/rpi-root/dev || true
          sudo umount /mnt/rpi-root/sys || true
          sudo umount /mnt/rpi-root/proc || true

          # Clean up (files may already be removed by the customization script)
          sudo rm /mnt/rpi-root/tmp/customize-image.sh 2>/dev/null || true
          sudo rm /mnt/rpi-root/usr/bin/qemu-arm-static 2>/dev/null || true

      - name: Unmount and cleanup
        if: always()
        run: |
          # Sync and unmount (in correct order)
          sync

          # Unmount pseudo-filesystems if still mounted
          sudo umount /mnt/rpi-root/dev/pts 2>/dev/null || true
          sudo umount /mnt/rpi-root/dev 2>/dev/null || true
          sudo umount /mnt/rpi-root/sys 2>/dev/null || true
          sudo umount /mnt/rpi-root/proc 2>/dev/null || true

          # Unmount main partitions
          sudo umount /mnt/rpi-boot || true
          sudo umount /mnt/rpi-root || true

          # Detach loop device
          sudo losetup -d $LOOP_DEVICE || true

          # Clean up mount points
          sudo rm -rf /mnt/rpi-boot /mnt/rpi-root

      - name: Compress image
        run: |
          echo "Compressing image..."
          IMAGE_FILENAME="${{ steps.vars.outputs.IMAGE_FILENAME }}"
          mv base-image.img "$IMAGE_FILENAME"

          # Compress with xz for better compression
          xz -9 -T 0 "$IMAGE_FILENAME"

          # Calculate checksums
          sha256sum "${IMAGE_FILENAME}.xz" > "${IMAGE_FILENAME}.xz.sha256"

      - name: Upload image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IMAGE_NAME }}-${{ steps.vars.outputs.VERSION }}
          path: |
            ${{ steps.vars.outputs.IMAGE_FILENAME }}.xz
            ${{ steps.vars.outputs.IMAGE_FILENAME }}.xz.sha256
          retention-days: 30

      - name: Create release and upload assets
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.vars.outputs.IMAGE_FILENAME }}.xz
            ${{ steps.vars.outputs.IMAGE_FILENAME }}.xz.sha256
          body: |
            ## Intercept Custom Raspberry Pi OS Image

            **Version:** ${{ steps.vars.outputs.VERSION }}
            **Base OS:** Raspberry Pi OS (${{ steps.vars.outputs.IMAGE_TYPE }}) - ${{ steps.vars.outputs.RPI_OS_VERSION }}

            ### Features
            - Pre-installed and configured intercept SIGINT platform
            - Auto-starts on boot
            - All dependencies installed
            - SSH enabled by default
            - Ready to use - just flash to SD card

            ### Installation
            1. Download the `.img.xz` file
            2. Verify checksum (optional): `sha256sum -c *.sha256`
            3. Flash to SD card using Raspberry Pi Imager or similar tool
            4. Insert SD card into Raspberry Pi and power on
            5. Wait for first boot (may take a few minutes)
            6. Access intercept at `http://<raspberry-pi-ip>:5050`

            ### Default Credentials
            - User: `pi`
            - Password: `raspberry` (change this after first boot!)

            ### Notes
            - SSH is enabled by default
            - Intercept runs as a systemd service
            - Logs available: `sudo journalctl -u intercept -f`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
